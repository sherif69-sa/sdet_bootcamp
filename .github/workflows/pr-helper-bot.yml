name: PR Helper Bot

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  run:
    if: |
      github.event.issue.pull_request != null &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'
      ) &&
      (
        github.event.comment.body == '/doctor' || startsWith(github.event.comment.body, '/doctor ') ||
        github.event.comment.body == '/check'  || startsWith(github.event.comment.body, '/check ') ||
        github.event.comment.body == '/quality' || startsWith(github.event.comment.body, '/quality ') ||
        github.event.comment.body == '/hint'   || startsWith(github.event.comment.body, '/hint ')
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        id: pr
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.issue.number,
            });
            core.setOutput('number', String(pr.data.number));
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('cmd', context.payload.comment.body.trim().split(/\s+/)[0]);

      - uses: actions/checkout@v4
        if: steps.pr.outputs.cmd != '/hint'
        with:
          ref: ${{ steps.pr.outputs.head_sha }}

      - uses: actions/setup-python@v5
        if: steps.pr.outputs.cmd != '/hint'
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-test.txt
            requirements-docs.txt

      - name: Install
        if: steps.pr.outputs.cmd != '/hint'
        run: |
          python -m pip install -r requirements-test.txt -r requirements-docs.txt
          python -m pip install -e .
          python -m pip install pre-commit

      - name: Run doctor
        if: steps.pr.outputs.cmd == '/doctor'
        run: |
          PYTHONPATH=src python -m sdetkit.doctor --ascii --json > doctor.json

      - name: Run check
        if: steps.pr.outputs.cmd == '/check'
        run: |
          python -m pre_commit run -a
          PYTHONPATH=src python -m sdetkit.doctor --ascii
          python -m pytest -q

      - name: Run quality gate
        if: steps.pr.outputs.cmd == '/quality'
        continue-on-error: true
        id: quality
        run: |
          bash quality.sh cov 2>&1 | tee quality.log

      - uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const prNumber = Number('${{ steps.pr.outputs.number }}');
            const cmd = '${{ steps.pr.outputs.cmd }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            let body = `✅ Bot finished \`${cmd}\`.\n\nWorkflow run: ${runUrl}\n`;

            if (cmd === '/doctor') {
              try {
                const data = JSON.parse(fs.readFileSync('doctor.json', 'utf8'));
                const items = (data.non_ascii || []).map(p => `- \`${p}\``).join('\n') || '- (none)';
                body += `\nNon-ASCII files:\n${items}\n`;
              } catch (e) {
                body += '\nCould not read doctor.json.\n';
              }
            }

            if (cmd === '/quality') {
              let coverage = 'unknown';
              try {
                const log = fs.readFileSync('quality.log', 'utf8');
                const match = log.match(/Total coverage: ([0-9]+\.[0-9]+)%/g);
                if (match && match.length > 0) {
                  coverage = match[match.length - 1].replace('Total coverage: ', '');
                }
                if ('${{ steps.quality.outcome }}' !== 'success') {
                  body = `❌ Bot finished \`${cmd}\` with failures.\n\nWorkflow run: ${runUrl}\n`;
                }
              } catch (e) {
                body += '\nCould not read quality.log.\n';
              }
              body += `\nCoverage (last reported): ${coverage}\n`;
              body += '- Suggested local fix: `python -m pip install -r requirements-test.txt -e . && bash quality.sh cov`\n';
            }

            if (cmd === '/hint') {
              body = `### Premium quality hints\n` +
                `- Run: \`python -m ruff format --check .\`\n` +
                `- Run: \`python -m pre_commit run -a\`\n` +
                `- Run: \`bash quality.sh cov\`\n` +
                `- Run: \`python -m build && python -m twine check dist/*\`\n` +
                `- Run docs gate for docs changes: \`mkdocs build\`\n` +
                `- Ensure PR summary includes: What, Why, Risks, Tests.\n` +
                `- Bot shortcuts: \`/doctor\`, \`/check\`, \`/quality\`, \`/hint\`\n` +
                `- Reference guide: \`docs/premium-quality-gate.md\`\n\n` +
                `Workflow run: ${runUrl}`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });
