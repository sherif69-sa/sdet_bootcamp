name: PR Helper Bot

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

jobs:
  run:
    if: |
      github.event.issue.pull_request != null &&
      github.actor == github.repository_owner &&
      (
        github.event.comment.body == '/doctor' || startsWith(github.event.comment.body, '/doctor ') ||
        github.event.comment.body == '/check'  || startsWith(github.event.comment.body, '/check ')
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        id: pr
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.issue.number,
            });
            core.setOutput('number', String(pr.data.number));
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('cmd', context.payload.comment.body.trim().split(/\s+/)[0]);

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_sha }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-test.txt
            requirements-docs.txt

      - name: Install
        run: |
          python -m pip install -r requirements-test.txt -r requirements-docs.txt
          python -m pip install -e .
          python -m pip install pre-commit

      - name: Run doctor
        if: steps.pr.outputs.cmd == '/doctor'
        run: |
          PYTHONPATH=src python -m sdetkit.doctor --ascii --json > doctor.json

      - name: Run check
        if: steps.pr.outputs.cmd == '/check'
        run: |
          pre-commit run -a
          PYTHONPATH=src python -m sdetkit.doctor --ascii
          python -m pytest -q

      - uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const prNumber = Number('${{ steps.pr.outputs.number }}');
            const cmd = '${{ steps.pr.outputs.cmd }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            let body = `âœ… Bot finished \`${cmd}\`.\n\nWorkflow run: ${runUrl}\n`;

            if (cmd === '/doctor') {
              try {
                const fs = require('fs');
                const data = JSON.parse(fs.readFileSync('doctor.json', 'utf8'));
                const items = (data.non_ascii || []).map(p => `- \`${p}\``).join('\n') || '- (none)';
                body += `\nNon-ASCII files:\n${items}\n`;
              } catch (e) {
                body += `\nCould not read doctor.json.\n`;
              }
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });
