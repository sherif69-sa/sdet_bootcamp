name: Mutation Tests

on:
  workflow_dispatch:
    inputs:
      target:
        description: "What to mutate"
        type: choice
        options:
          - textutil
          - atomicio
          - kvcli
          - cli
          - all
        default: textutil
  schedule:
    - cron: "0 3 * * 0"  # weekly (UTC)

permissions:
  contents: read

concurrency:
  group: mutmut-${{ github.ref }}
  cancel-in-progress: true

jobs:
  mutmut:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-test.txt
            requirements-docs.txt

      - name: Install
        run: |
          python -m pip install -r requirements-test.txt -r requirements-docs.txt
          python -m pip install -e .
          python -m pip install mutmut

      - name: Run mutation tests
        env:
          TARGET: ${{ github.event.inputs.target || 'textutil' }}
        run: |
          set -euo pipefail

          run_one() {
            name="$1"
            path="$2"
            shift 2
            runner="$*"

            rm -rf html .mutmut-cache .mutmut-results artifacts
            mkdir -p artifacts

            mutmut run --paths-to-mutate "$path" --runner "$runner" || true
            mutmut results || true
            mutmut html || true

            if [ -d html ]; then
              mv html "artifacts/html-${name}"
            fi
            if [ -d .mutmut-results ]; then
              cp -a .mutmut-results "artifacts/results-${name}"
            fi
            if [ -d .mutmut-cache ]; then
              cp -a .mutmut-cache "artifacts/cache-${name}"
            fi
          }

          case "$TARGET" in
            textutil)
              run_one textutil src/sdetkit/textutil.py python -m pytest -q tests/test_textutil.py
              ;;
            atomicio)
              run_one atomicio src/sdetkit/atomicio.py python -m pytest -q tests/test_atomicio.py
              ;;
            kvcli)
              run_one kvcli src/sdetkit/kvcli.py python -m pytest -q tests/test_kvcli.py
              ;;
            cli)
              run_one cli src/sdetkit/cli.py python -m pytest -q tests/test_cli_sdetkit.py tests/test_entrypoints_smoke.py tests/test_cli_smoke_coverage.py
              ;;
            all)
              run_one textutil src/sdetkit/textutil.py python -m pytest -q tests/test_textutil.py
              run_one atomicio src/sdetkit/atomicio.py python -m pytest -q tests/test_atomicio.py
              run_one kvcli src/sdetkit/kvcli.py python -m pytest -q tests/test_kvcli.py
              run_one cli src/sdetkit/cli.py python -m pytest -q tests/test_cli_sdetkit.py tests/test_entrypoints_smoke.py tests/test_cli_smoke_coverage.py
              ;;
            *)
              echo "Unknown TARGET=$TARGET" >&2
              exit 2
              ;;
          esac

      - name: Upload mutmut report
        if: always()
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f  # v7.0.0
        with:
          name: mutmut-${{ github.run_id }}
          path: artifacts
          if-no-files-found: warn
