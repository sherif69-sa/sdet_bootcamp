name: Weekly Maintenance

on:
  schedule:
    - cron: "0 5 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: pyproject.toml

      - name: Install project + dev/test extras
        run: |
          python -m pip install -U pip
          python -m pip install -e .[dev,test]

      - name: Run maintenance baseline
        run: bash scripts/maintenance_ci.sh full false artifacts/maintenance

      - name: Upload baseline artifacts
        uses: actions/upload-artifact@v6
        with:
          name: weekly-maintenance
          path: |
            artifacts/maintenance.json
            artifacts/maintenance.md

      - name: Decide whether to run fixes
        id: decide_fix
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          report = json.loads(Path('artifacts/maintenance.json').read_text())
          lint_ok = report.get('checks', {}).get('lint_check', {}).get('ok', True)
          needs_fix = (not report.get('ok', True)) or (not lint_ok)
          print(f"run_fix={'true' if needs_fix else 'false'}")
          import os
          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as fh:
              fh.write(f"run_fix={'true' if needs_fix else 'false'}\n")
          PY

      - name: Run maintenance fix mode
        if: steps.decide_fix.outputs.run_fix == 'true'
        run: bash scripts/maintenance_ci.sh full true artifacts/maintenance

      - name: Upload fix artifacts
        if: steps.decide_fix.outputs.run_fix == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: weekly-maintenance-fixed
          path: |
            artifacts/maintenance_fixed.json
            artifacts/maintenance_fixed.md

      - name: Prepare PR summary
        id: pr_summary
        if: steps.decide_fix.outputs.run_fix == 'true'
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          before = json.loads(Path('artifacts/maintenance.json').read_text())
          after_path = Path('artifacts/maintenance_fixed.json')
          after = json.loads(after_path.read_text()) if after_path.exists() else before
          applied = []
          for name, item in after.get('checks', {}).items():
            for action in item.get('actions', []):
              if action.get('applied'):
                applied.append(f"- `{name}`: {action.get('title')} ({action.get('notes', '').strip()[:120]})")
          body = "\n".join([
            "## Weekly maintenance auto-fix",
            f"- score before: {before.get('score')}",
            f"- score after: {after.get('score')}",
            "- workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "",
            "### Applied actions",
            *(applied or ["- none"]),
          ])
          Path('artifacts/pr_body.md').write_text(body + "\n", encoding='utf-8')
          PY

      - name: Create pull request
        id: cpr
        if: steps.decide_fix.outputs.run_fix == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: weekly maintenance"
          title: "chore: weekly maintenance"
          body-path: artifacts/pr_body.md
          branch: automation/weekly-maintenance
          base: main

      - name: Update weekly issue
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: "83"
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${context.runId}`;
            const issueDefault = Number(process.env.ISSUE_NUMBER || '83');

            const report = JSON.parse(fs.readFileSync('artifacts/maintenance.json', 'utf8'));
            const mdPath = path.join('artifacts', 'maintenance.md');
            const md = fs.existsSync(mdPath) ? fs.readFileSync(mdPath, 'utf8') : '';

            const checks = Object.entries(report.checks || {})
              .map(([name, item]) => `| ${name} | ${item.ok ? 'PASS' : 'FAIL'} | ${item.summary} |`)
              .join('\n');

            const truncatedMd = md.length > 5000 ? `${md.slice(0, 5000)}\n\n... (truncated)` : md;

            const body = [
              `## Weekly Maintenance Run (${new Date().toISOString()})`,
              `- score: ${report.score}`,
              `- workflow run: ${runUrl}`,
              `- pull request: ${process.env.PR_URL || 'not created'}`,
              '',
              '| Check | Status | Summary |',
              '| --- | --- | --- |',
              checks || '| n/a | n/a | n/a |',
              '',
              '<details><summary>Markdown report</summary>',
              '',
              truncatedMd,
              '',
              '</details>',
            ].join('\n');

            let issueNumber = issueDefault;
            try {
              await github.rest.issues.get({ owner, repo, issue_number: issueDefault });
            } catch (error) {
              const created = await github.rest.issues.create({
                owner,
                repo,
                title: 'Weekly Maintenance',
                labels: ['maintenance'],
                body: 'Auto-created because issue #83 was unavailable.',
              });
              issueNumber = created.data.number;
            }

            await github.rest.issues.createComment({ owner, repo, issue_number: issueNumber, body });
