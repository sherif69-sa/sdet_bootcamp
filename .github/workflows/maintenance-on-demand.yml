name: Maintenance On Demand

on:
  workflow_dispatch:
    inputs:
      mode:
        description: quick or full maintenance mode
        type: choice
        required: true
        default: full
        options:
          - quick
          - full
      fix:
        description: apply safe fixes
        type: boolean
        required: true
        default: false
      pr:
        description: open PR when fix introduces changes
        type: boolean
        required: true
        default: false
      issue_number:
        description: issue number to update
        type: number
        required: true
        default: 83

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: pyproject.toml

      - name: Install project + dev/test extras
        run: |
          python -m pip install -U pip
          python -m pip install -e .[dev,test]

      - name: Run maintenance
        run: bash scripts/maintenance_ci.sh "${{ inputs.mode }}" "${{ inputs.fix && 'true' || 'false' }}" artifacts/maintenance

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maintenance-on-demand
          path: |
            artifacts/maintenance.json
            artifacts/maintenance.md
            artifacts/maintenance_fixed.json
            artifacts/maintenance_fixed.md
          if-no-files-found: ignore

      - name: Detect diff
        id: diff
        run: |
          if git diff --quiet; then
            echo "has_diff=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_diff=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare PR summary
        if: inputs.pr && steps.diff.outputs.has_diff == 'true'
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          before = json.loads(Path('artifacts/maintenance.json').read_text())
          after_path = Path('artifacts/maintenance_fixed.json')
          after = json.loads(after_path.read_text()) if after_path.exists() else before
          applied = []
          for name, item in after.get('checks', {}).items():
            for action in item.get('actions', []):
              if action.get('applied'):
                applied.append(f"- `{name}`: {action.get('title')}")
          Path('artifacts/pr_body.md').write_text(
            "\n".join([
              "## Maintenance on demand auto-fix",
              f"- score before: {before.get('score')}",
              f"- score after: {after.get('score')}",
              "- workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "",
              "### Applied actions",
              *(applied or ["- none"]),
            ]) + "\n",
            encoding='utf-8',
          )
          PY

      - name: Create pull request
        id: cpr
        if: inputs.pr && steps.diff.outputs.has_diff == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: weekly maintenance"
          title: "chore: weekly maintenance"
          body-path: artifacts/pr_body.md
          branch: automation/maintenance-on-demand
          base: main

      - name: Update maintenance issue
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueDefault = Number(process.env.ISSUE_NUMBER || '83');
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${context.runId}`;

            const report = JSON.parse(fs.readFileSync('artifacts/maintenance.json', 'utf8'));
            const md = fs.existsSync('artifacts/maintenance.md')
              ? fs.readFileSync('artifacts/maintenance.md', 'utf8')
              : '';

            const rows = Object.entries(report.checks || {})
              .map(([name, item]) => `| ${name} | ${item.ok ? 'PASS' : 'FAIL'} | ${item.summary} |`)
              .join('\n');

            const comment = [
              `## Maintenance On-Demand (${new Date().toISOString()})`,
              `- score: ${report.score}`,
              `- workflow run: ${runUrl}`,
              `- pull request: ${process.env.PR_URL || 'not created'}`,
              '',
              '| Check | Status | Summary |',
              '| --- | --- | --- |',
              rows || '| n/a | n/a | n/a |',
              '',
              md.length > 5000 ? `${md.slice(0, 5000)}\n\n... (truncated)` : md,
            ].join('\n');

            let issueNumber = issueDefault;
            try {
              await github.rest.issues.get({ owner, repo, issue_number: issueDefault });
            } catch (error) {
              const created = await github.rest.issues.create({
                owner,
                repo,
                title: 'Weekly Maintenance',
                labels: ['maintenance'],
                body: 'Auto-created because requested maintenance issue was unavailable.',
              });
              issueNumber = created.data.number;
            }

            await github.rest.issues.createComment({ owner, repo, issue_number: issueNumber, body: comment });
